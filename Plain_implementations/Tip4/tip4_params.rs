use crate::fields::goldilocks::Goldilocks;
use crate::fields::FieldElement;
use crate::utils::modinv;
use num_bigint::BigUint;
use num_traits::ToPrimitive;

pub const NUM_ROUNDS: usize = 5;
pub const NUM_SPLIT_AND_LOOKUP: usize = 4;

pub const LOOKUP_TABLE: [u8; 256] = [
    0, 7, 26, 63, 124, 215, 85, 254, 214, 228, 45, 185, 140, 173, 33, 240,
    29, 177, 176, 32, 8, 110, 87, 202, 204, 99, 150, 106, 230, 14, 235, 128,
    213, 239, 212, 138, 23, 130, 208, 6, 44, 71, 93, 116, 146, 189, 251, 81,
    199, 97, 38, 28, 73, 179, 95, 84, 152, 48, 35, 119, 49, 88, 242, 3,
    148, 169, 72, 120, 62, 161, 166, 83, 175, 191, 137, 19, 100, 129, 112, 55,
    221, 102, 218, 61, 151, 237, 68, 164, 17, 147, 46, 234, 203, 216, 22, 141,
    65, 57, 123, 12, 244, 54, 219, 231, 96, 77, 180, 154, 5, 253, 133, 165,
    98, 195, 205, 134, 245, 30, 9, 188, 59, 142, 186, 197, 181, 144, 92, 31,
    224, 163, 111, 74, 58, 69, 113, 196, 67, 246, 225, 10, 121, 50, 60, 157,
    90, 122, 2, 250, 101, 75, 178, 159, 24, 36, 201, 11, 243, 132, 198, 190,
    114, 233, 39, 52, 21, 209, 108, 238, 91, 187, 18, 104, 194, 37, 153, 34,
    200, 143, 126, 155, 236, 118, 64, 80, 172, 89, 94, 193, 135, 183, 86, 107,
    252, 13, 167, 206, 136, 220, 207, 103, 171, 160, 76, 182, 227, 217, 158, 56,
    174, 4, 66, 109, 139, 162, 184, 211, 249, 47, 125, 232, 117, 43, 16, 42,
    127, 20, 241, 25, 149, 105, 156, 51, 53, 168, 145, 247, 223, 79, 78, 226,
    15, 222, 82, 115, 70, 210, 27, 41, 1, 170, 40, 131, 192, 229, 248, 255
];

pub const TIP4_MDS_ROW: [u64; 16] = [
    18446742626305572865, 12103477672291081763, 2060678330275253760, 2379906257383880660, 13229869363167232, 12103947580051285184, 3631871650260640512, 18375880622847003104,
    18446743700047396865, 7491684177549991903, 16328081945490043393, 11603770461046470701, 18433515290973110273, 5185371269165997376, 14872856315882446081, 4542937756286289441
];

pub const TIP4_ARK: [[u64; 16]; NUM_ROUNDS] = [
    [
    2773304578597675691, 6577486792949837289, 852496478296018148, 16274170413028223467, 14605556261657613220, 6152165206438359141, 15057099056019636764, 13517296912152680108,
    17054742691533556812, 6341951011695620811, 10169721560204385358, 11465675366522771128, 2603780028585251745, 7284707811386517733, 15657741767723286768, 7510473197084447883
    ],
    [
    6824566801901421045, 3248632376753140628, 11802262156923856194, 2029950643527673097, 12955837704434711946, 3025867304903145181, 7509795665398296293, 16685304952218962269,
    4567878395159684384, 1972986699562740861, 14185129589909338578, 11979170182009124666, 15476483599310168521, 5279342618637217663, 5634964063642576200, 1484231609263707727
    ],
    [
    16667572506962507444, 15637294586264079072, 17032005680486883117, 4187237233419016829, 2139125161119014851, 2682540547565227553, 2952252929783518056, 5910024256582240379,
    9257057599927667657, 3512513996070927994, 1183473989326272222, 11010640797567402430, 4585718743403387242, 12713202526603908035, 10934964261715330312, 7364737023790477939
    ],
    [
    14718583028145944926, 15831238359525517579, 205679036149192672, 3414264619954948141, 3328070596152154954, 18409310207893973078, 15910675967671337140, 14764179545750094344,
    11120646421218400919, 860545110039176289, 12250343788408695703, 5975459723373140194, 10523684464911246857, 6947239181784728254, 2198247791395281312, 7594475151066749733
    ],
    [
    11451408280463063245, 13798728584773383083, 818092332272994362, 7802557965910998345, 17589411335691969176, 9709960486609042571, 14026276246063895922, 4657968305375643740,
    16055925911245599980, 17152524033963190290, 3342740266691127965, 11358178825351148260, 5862165971954099526, 12235899178513255067, 2927725875639817919, 11784104199241925722
    ]
];

pub const TIP4P_MDS_ROW: [u64; 12] = [
    7, 23, 8, 26, 13, 10,
    9, 7, 6, 22, 21, 8
];

pub const TIP4P_ARK: [[u64; 12]; NUM_ROUNDS] = [
    [
    6389859829374159539, 17229380705756925792, 1685504065768360085, 11495601389602964927, 14590499332882967787, 1025546974836270924,
    6534388361641189904, 83528329195322609, 16825958830920599305, 14367535913531541706, 9373882113169352939, 15206069388815085038
    ],
    [
    11737921204895515252, 16675938809814109201, 3081949179470873665, 14408516998600831324, 1734666691041050162, 6965669371710145373,
    2627545038496711157, 4131567233355311863, 6663606854236214944, 4356348818072343221, 16977499875487476107, 7133528005210469376
    ],
    [
    6576072100995654613, 10365773285517510429, 5099169911046663151, 8204666535893592250, 8197747920434370952, 14055144323705103704,
    3823557958183613205, 13605446815893856691, 5735413688512934979, 6851805580612830374, 15826549711290838538, 12685129780251896487
    ],
    [
    14630567176945838998, 10914381549746387617, 7421170053404255007, 729729048984908966, 14034826357100489727, 1838990003271062491,
    1898220471987185721, 16545038689555322876, 8094685071437843378, 12850344507116018299, 12312176261866659209, 15951038048410299964
    ],
    [
    10272996019760781151, 15604072713712758006, 16041565754647052886, 14050558224171946805, 7797167814871903221, 14703987605672997265,
    489387044347918799, 16525276081598735217, 18290527903441405997, 14091853142054427371, 10013792448977695701, 5570882487753758060
    ]
];

pub trait Tip4Field: FieldElement {
    fn to_u64(&self) -> u64;
}

impl Tip4Field for Goldilocks {
    fn to_u64(&self) -> u64 {
        Goldilocks::to_u64(self)
    }
}

#[derive(Clone, Debug)]
pub struct Tip4Params<F: Tip4Field> {
    pub(crate) t: usize,
    pub(crate) rounds: usize,
    pub(crate) round_constants: Vec<Vec<F>>,
    pub(crate) mds: Vec<Vec<F>>,
    pub(crate) r: F,
    pub(crate) r_inv: F,
}

impl Tip4Params<Goldilocks> {
    pub fn new_tip4() -> Self {
        let round_constants = TIP4_ARK
            .iter()
            .map(|row| row.iter().map(|&v| Goldilocks::from_u64(v)).collect())
            .collect();
        let mds = circulant_from_row(&TIP4_MDS_ROW);
        let (r, r_inv) = monty_constants();
        Tip4Params {
            t: TIP4_MDS_ROW.len(),
            rounds: NUM_ROUNDS,
            round_constants,
            mds,
            r,
            r_inv,
        }
    }

    pub fn new_tip4p() -> Self {
        let round_constants = TIP4P_ARK
            .iter()
            .map(|row| row.iter().map(|&v| Goldilocks::from_u64(v)).collect())
            .collect();
        let mds = circulant_from_row(&TIP4P_MDS_ROW);
        let (r, r_inv) = monty_constants();
        Tip4Params {
            t: TIP4P_MDS_ROW.len(),
            rounds: NUM_ROUNDS,
            round_constants,
            mds,
            r,
            r_inv,
        }
    }
}

fn monty_constants() -> (Goldilocks, Goldilocks) {
    let r = Goldilocks::from_u64((1u64 << 32) - 1);
    let modulus = BigUint::from(Goldilocks::MODULUS);
    let r_inv_big = modinv(&BigUint::from((1u64 << 32) - 1), &modulus);
    let r_inv = Goldilocks::from_u64(r_inv_big.to_u64().expect("r_inv fits into u64"));
    (r, r_inv)
}

fn circulant_from_row<F: FieldElement, const N: usize>(row: &[u64; N]) -> Vec<Vec<F>> {
    let t = row.len();
    let mut mat = Vec::with_capacity(t);
    let mut rot: Vec<F> = row.iter().map(|&v| F::from_u64(v)).collect();
    mat.push(rot.clone());
    for _ in 1..t {
        rot.rotate_right(1);
        mat.push(rot.clone());
    }
    mat
}
