use super::tip4::Tip4Params;
use crate::fields::goldilocks::Goldilocks;
use crate::fields::FieldElement;
use crate::utils::modinv;
use lazy_static::lazy_static;
use num_bigint::BigUint;
use num_traits::ToPrimitive;
use std::sync::Arc;

pub(crate) const NUM_ROUNDS: usize = 5;
pub(crate) const NUM_SPLIT_AND_LOOKUP: usize = 4;

pub(crate) const LOOKUP_TABLE: [u8; 256] = [
    0, 7, 26, 63, 124, 215, 85, 254, 214, 228, 45, 185, 140, 173, 33, 240, 29, 177, 176, 32,
    8, 110, 87, 202, 204, 99, 150, 106, 230, 14, 235, 128, 213, 239, 212, 138, 23, 130, 208, 6,
    44, 71, 93, 116, 146, 189, 251, 81, 199, 97, 38, 28, 73, 179, 95, 84, 152, 48, 35, 119, 49,
    88, 242, 3, 148, 169, 72, 120, 62, 161, 166, 83, 175, 191, 137, 19, 100, 129, 112, 55, 221,
    102, 218, 61, 151, 237, 68, 164, 17, 147, 46, 234, 203, 216, 22, 141, 65, 57, 123, 12, 244,
    54, 219, 231, 96, 77, 180, 154, 5, 253, 133, 165, 98, 195, 205, 134, 245, 30, 9, 188, 59,
    142, 186, 197, 181, 144, 92, 31, 224, 163, 111, 74, 58, 69, 113, 196, 67, 246, 225, 10, 121,
    50, 60, 157, 90, 122, 2, 250, 101, 75, 178, 159, 24, 36, 201, 11, 243, 132, 198, 190, 114,
    233, 39, 52, 21, 209, 108, 238, 91, 187, 18, 104, 194, 37, 153, 34, 200, 143, 126, 155, 236,
    118, 64, 80, 172, 89, 94, 193, 135, 183, 86, 107, 252, 13, 167, 206, 136, 220, 207, 103, 171,
    160, 76, 182, 227, 217, 158, 56, 174, 4, 66, 109, 139, 162, 184, 211, 249, 47, 125, 232, 117,
    43, 16, 42, 127, 20, 241, 25, 149, 105, 156, 51, 53, 168, 145, 247, 223, 79, 78, 226, 15,
    222, 82, 115, 70, 210, 27, 41, 1, 170, 40, 131, 192, 229, 248, 255,
];

const TIP4P_MDS_ROW: [u64; 12] = [7, 23, 8, 26, 13, 10, 9, 7, 6, 22, 21, 8];

const TIP4P_ARK: [[u64; 12]; NUM_ROUNDS] = [
    [
        6389859829374159539,
        17229380705756925792,
        1685504065768360085,
        11495601389602964927,
        14590499332882967787,
        1025546974836270924,
        6534388361641189904,
        83528329195322609,
        16825958830920599305,
        14367535913531541706,
        9373882113169352939,
        15206069388815085038,
    ],
    [
        11737921204895515252,
        16675938809814109201,
        3081949179470873665,
        14408516998600831324,
        1734666691041050162,
        6965669371710145373,
        2627545038496711157,
        4131567233355311863,
        6663606854236214944,
        4356348818072343221,
        16977499875487476107,
        7133528005210469376,
    ],
    [
        6576072100995654613,
        10365773285517510429,
        5099169911046663151,
        8204666535893592250,
        8197747920434370952,
        14055144323705103704,
        3823557958183613205,
        13605446815893856691,
        5735413688512934979,
        6851805580612830374,
        15826549711290838538,
        12685129780251896487,
    ],
    [
        14630567176945838998,
        10914381549746387617,
        7421170053404255007,
        729729048984908966,
        14034826357100489727,
        1838990003271062491,
        1898220471987185721,
        16545038689555322876,
        8094685071437843378,
        12850344507116018299,
        12312176261866659209,
        15951038048410299964,
    ],
    [
        10272996019760781151,
        15604072713712758006,
        16041565754647052886,
        14050558224171946805,
        7797167814871903221,
        14703987605672997265,
        489387044347918799,
        16525276081598735217,
        18290527903441405997,
        14091853142054427371,
        10013792448977695701,
        5570882487753758060,
    ],
];

lazy_static! {
    pub static ref TIP4P_GOLDILOCKS_PARAMS: Arc<Tip4Params<Goldilocks>> = {
        let round_constants = TIP4P_ARK
            .iter()
            .map(|row| row.iter().map(|&v| Goldilocks::from_u64(v)).collect())
            .collect();
        let mds = circulant_from_row(&TIP4P_MDS_ROW);
        let (r, r_inv) = monty_constants();
        Arc::new(Tip4Params {
            t: TIP4P_MDS_ROW.len(),
            rounds: NUM_ROUNDS,
            round_constants,
            mds,
            r,
            r_inv,
        })
    };
}

fn monty_constants() -> (Goldilocks, Goldilocks) {
    let r = Goldilocks::from_u64((1u64 << 32) - 1);
    let modulus = BigUint::from(Goldilocks::MODULUS);
    let r_inv_big = modinv(&BigUint::from((1u64 << 32) - 1), &modulus);
    let r_inv = Goldilocks::from_u64(r_inv_big.to_u64().expect("r_inv fits into u64"));
    (r, r_inv)
}

fn circulant_from_row<F: FieldElement, const N: usize>(row: &[u64; N]) -> Vec<Vec<F>> {
    let t = row.len();
    let mut mat = Vec::with_capacity(t);
    let mut rot: Vec<F> = row.iter().map(|&v| F::from_u64(v)).collect();
    mat.push(rot.clone());
    for _ in 1..t {
        rot.rotate_right(1);
        mat.push(rot.clone());
    }
    mat
}
